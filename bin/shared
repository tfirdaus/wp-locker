#!/bin/bash

run() {
    docker-compose exec -u www-data wordpress $@
}

run_root() {
	docker-compose exec wordpress $@
}

ssh() {
	docker-compose exec -u www-data wordpress sh
}

ssh_root() {
	docker-compose exec wordpress sh
}

replace_urls() {
	echo "üîé Verifying the site URLs."

	regex='(http|https)://[-A-Za-z0-9\+&@#/%?=~_|!:,.;]*[-A-Za-z0-9\+&@#/%=~_|]'
	if [[ $1 =~ $regex ]]; then
		SITEURL=$(run wp option get siteurl)
		SITEURL_ESC=$(echo -e "$SITEURL" | sed -e 's/[[:space:]]*$//' -e "s/'//g")
	else
		echo "‚õîÔ∏è URL is not valid or supplied."
	fi

	if [[ ! -z $SITEURL_ESC ]] && [[ "$1" != "$SITEURL_ESC" ]]; then
		echo "üîÑ Replacing the site URLs in the database to $1."
		run wp search-replace "$SITEURL_ESC" "$1" --precise --recurse-objects --all-tables --skip-themes --skip-plugins
	else
		echo "üëåüèº Done!"
	fi
}

install_git_repo() {
	# Don't bother proceeding if the `git` command is not present.
	if [[ ! `which git` ]]; then
		echo "‚õîÔ∏è Cannot clone Git repositories. Git is not installed on your system."
		exit 1
	fi

	GIT_REPOS=$1

	for i in "${@:2}"; do
		case $i in
			--source=*)
			if [[ ${i#*=} = "bitbucket" ]]; then
				REPO_BASEURL=https://bitbucket.org/
			fi
			shift;;
			--clone-dir=*)
				REPO_CLONE_DIR=${i#*=}
			shift;;
		esac
	done

	IFS=',' read -ra repositories <<< "$GIT_REPOS"
	if [[ ${repositories[@]} ]]; then
		# Ensure the directory is there.
		mkdir -p ${REPO_CLONE_DIR:-wp-content} && cd ${REPO_CLONE_DIR:-wp-content}

		# Loop through it.
		for repo in "${repositories[@]}"; do
			echo "üì¶ Cloning '${repo%:*}' to '${REPO_CLONE_DIR:-wp-content}/${repo#*:}'."
			git clone ${REPO_BASEURL:-https://github.com/}${repo%:*}.git ${repo#*:}
		done
		cd - &>/dev/null
	else
		echo "‚ùé No Git repository to clone. The --source parameter might no be specified."
	fi
}

banner() {
	cat <<-'EOF'
  _       ______        __    ____  ________ __ __________
 | |     / / __ \      / /   / __ \/ ____/ //_// ____/ __ \
 | | /| / / /_/ /_____/ /   / / / / /   / ,<  / __/ / /_/ /
 | |/ |/ / ____/_____/ /___/ /_/ / /___/ /| |/ /___/ _, _/
 |__/|__/_/         /_____/\____/\____/_/ |_/_____/_/ |_|

    Repository: https://github.com/tfirdaus/wp-locker

	EOF
}
