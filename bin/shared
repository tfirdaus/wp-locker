#!/bin/bash

run() {
    docker-compose exec -u www-data wordpress $@
}

run_root() {
	docker-compose exec wordpress $@
}

ssh() {
	docker-compose exec -u www-data wordpress sh
}

ssh_root() {
	docker-compose exec wordpress sh
}

replace_urls() {

	regex='(http|https)://[-A-Za-z0-9\+&@#/%?=~_|!:,.;]*[-A-Za-z0-9\+&@#/%=~_|]'
	if [[ $1 =~ $regex ]]; then
		local SITEURL=$(run wp option get siteurl)
		local SITEURL_ESC=$(echo -e "$SITEURL" | sed -e 's/[[:space:]]*$//' -e "s/'//g")
	else
		echo "‚õîÔ∏è URL is not valid or supplied."
	fi

	if [[ ! -z $SITEURL_ESC ]] && [[ "$1" != "$SITEURL_ESC" ]]; then
		echo "üîÑ Replacing the site URLs in the database to $1."
		run wp search-replace "$SITEURL_ESC" "$1" --precise --recurse-objects --all-tables --skip-themes --skip-plugins
	fi
}

install_wp() {
	if [ $# -lt 2 ]; then
		echo "usage: $0 <plugin|theme> <list-of-plugins|theme>"
	fi

	if [[ "$1" = "plugin" ]] || [[ "$1" = "theme" ]]; then

		local PLUGINS_INSTALLED=()

		# Install WordPress plugins
		IFS=',' read -ra WP_REPOS <<< "$2"
		if [[ ${WP_REPOS[@]} ]]; then
			for WP_REPO in "${WP_REPOS[@]}"; do
				if ! $(run wp $1 is-installed $WP_REPO) && [[ "$1" = "plugin" ]]; then
					PLUGINS_INSTALLED+=("$WP_REPO")
				fi

				if ! $(run wp $1 is-installed $WP_REPO) && [[ "$1" = "theme" ]] && [[ -z $THEME_INSTALLED ]]; then
					local THEME_INSTALLED=$WP_REPO
				fi
			done

			if [[ ${PLUGINS_INSTALLED[@]} ]]; then
				run_root wp plugin install "${PLUGINS_INSTALLED[@]}" --activate --allow-root
			fi

			if [[ "$1" = "theme" ]] && [[ ! -z $THEME_INSTALLED ]]; then
				run_root wp theme install $THEME_INSTALLED --activate --allow-root
			fi
		fi
	fi
}

install_git_repo() {
	# Don't bother proceeding if the `git` command is not present.
	if [[ ! `which git` ]]; then
		echo "‚õîÔ∏è Cannot clone Git repositories. Git is not installed on your system."
		exit 1
	fi

	local GIT_REPOS=$1

	for i in "${@:2}"; do
		case $i in
			--source=*)
			if [[ ${i#*=} = "bitbucket" ]]; then
				local REPO_BASEURL=https://bitbucket.org/
			fi
			shift;;
			--dest=*)
				local REPO_DEST=${i#*=}
			shift;;
		esac
	done

	IFS=',' read -ra repositories <<< "$GIT_REPOS"
	if [[ ${repositories[@]} ]]; then
		# Ensure the directory is there.
		mkdir -p ${REPO_DEST:-wp-content} && cd ${REPO_DEST:-wp-content}

		# Loop through it.
		for repo in "${repositories[@]}"; do
			local REPO_DIR=$(echo $repo | cut -d'/' -f2 | cut -d':' -f2)
			if [[ -z "$(ls -A ${REPO_DIR:-})" ]]; then
				echo "Cloning '${repo%:*}' to '${REPO_DEST:-wp-content}/${REPO_DIR:-}'."
				git clone ${REPO_BASEURL:-https://github.com/}${repo%:*}.git ${REPO_DIR:-}
			fi
		done
		cd - &>/dev/null
	fi
}

banner() {
    if [[ -z $NOBANNER ]]; then
	cat <<-'EOF'
  _       ______        __    ____  ________ __ __________
 | |     / / __ \      / /   / __ \/ ____/ //_// ____/ __ \
 | | /| / / /_/ /_____/ /   / / / / /   / ,<  / __/ / /_/ /
 | |/ |/ / ____/_____/ /___/ /_/ / /___/ /| |/ /___/ _, _/
 |__/|__/_/         /_____/\____/\____/_/ |_/_____/_/ |_|

    Repository: https://github.com/tfirdaus/wp-locker

	EOF
    fi
}
